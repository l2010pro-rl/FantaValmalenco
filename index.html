<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FantaValmalenco - Accedi</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color:white; padding:10px; min-height:100vh; }
    .container { max-width:800px; margin:0 auto; background:rgba(0,0,0,0.85); padding:20px; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,0.6); }
    h1, h2 { text-align:center; color:#4fc3f7; margin:15px 0; }
    .form-group { margin:12px 0; }
    label { display:block; margin:6px 0 4px; font-weight:bold; }
    input { width:100%; padding:10px; border-radius:6px; border:none; background:rgba(255,255,255,0.1); color:white; }
    input::placeholder { color:#aaa; }
    button { width:100%; padding:12px; background:#2196f3; color:white; font-weight:bold; border:none; border-radius:6px; cursor:pointer; margin:10px 0; }
    .google-btn {
      background: #4285F4;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .google-btn:hover { background: #3367D6; }
    .error { color:#ff6b6b; text-align:center; margin:10px 0; }
    .nav-tabs { display:flex; justify-content:center; gap:10px; margin:20px 0; flex-wrap:wrap; }
    .nav-tabs button { width:auto; padding:8px 16px; background:#333; margin:0; }
    .nav-tabs button.active { background:#2196f3; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .leaderboard-item { display:flex; justify-content:space-between; padding:12px; margin:8px 0; background:rgba(255,255,255,0.1); border-radius:8px; align-items:center; }
    .avatar { width:40px; height:40px; border-radius:50%; background:#555; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px; }
    .avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
    .user-info { display:flex; align-items:center; }
    .logout-btn { background:#f44336; margin-top:20px; }
    .logout-btn:hover { background:#d32f2f; }
    .rules ul { padding-left:20px; margin:15px 0; }
    .rules li { margin:8px 0; }
    .preview { width:100px; height:100px; border-radius:50%; margin:10px auto; background:#444; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .preview img { width:100%; height:100%; object-fit:cover; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Schermata Autenticazione -->
    <div id="authScreen">
      <h1>üéÆ FantaValmalenco</h1>
      <p style="text-align:center;">Accedi con email o Google!</p>

      <!-- Login Email -->
      <div id="loginForm">
        <h2>Accedi con Email</h2>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="loginUser" placeholder="Il tuo username" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPass" placeholder="La tua password" />
        </div>
        <button onclick="loginEmail()">Accedi</button>
        <p style="text-align:center; margin:10px 0;">
          Non hai un account? <a href="#" onclick="showAuth('register')" style="color:#4fc3f7;">Registrati</a>
        </p>
        <div id="loginError" class="error"></div>
      </div>

      <!-- Pulsante Google -->
      <button class="google-btn" onclick="loginGoogle()">
        <svg width="20" height="20" viewBox="0 0 256 262" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid">
          <path d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 34.944-56.639 34.944-97.93z" fill="#4285F4"/>
          <path d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.053-45.257 13.053-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1z" fill="#34A853"/>
          <path d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.01 89.644 0 109.517 0 130.55s5.01 40.905 13.94 58.602l42.341-32.782z" fill="#FBBC05"/>
          <path d="M130.55 50.479c24.513 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.944 165.798 0 130.55 0 79.49 0 35.393 29.301 13.94 50.76l42.341 32.782c10.873-33.37 42.378-57.871 76.27-57.871z" fill="#EA4335"/>
        </svg>
        Accedi con Google
      </button>

      <!-- Registrazione -->
      <div id="registerForm" style="display:none;">
        <h2>Registrati</h2>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="regUser" placeholder="Scegli username unico" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="regPass" placeholder="Minimo 6 caratteri" />
        </div>
        <div class="form-group">
          <label>Conferma Password</label>
          <input type="password" id="regPass2" placeholder="Ripeti password" />
        </div>
        <button onclick="register()">Registrati</button>
        <p style="text-align:center; margin-top:10px;">
          Hai gi√† un account? <a href="#" onclick="showAuth('login')" style="color:#4fc3f7;">Accedi</a>
        </p>
        <div id="regError" class="error"></div>
      </div>
    </div>

    <!-- App Principale -->
    <div id="appScreen" style="display:none;">
      <h1>Benvenuto, <span id="currentUser"></span>!</h1>

      <div class="nav-tabs">
        <button onclick="showTab('leaderboard')" id="tab-leaderboard">Classifica</button>
        <button onclick="showTab('rules')" id="tab-rules">Regole</button>
        <button onclick="showTab('settings')" id="tab-settings">Impostazioni</button>
      </div>

      <div id="leaderboard" class="tab-content active">
        <h2>üèÜ Classifica Generale</h2>
        <div id="leaderboardList"></div>
      </div>

      <div id="rules" class="tab-content">
        <h2>üìú Regolamento</h2>
        <div class="rules">
          <p>Ogni utente √® un giocatore attivo. I punti sono salvati su server Firebase.</p>
          <ul>
            <li><strong>+20 punti</strong> alla registrazione</li>
            <li><strong>+10 punti</strong> per ogni login (max 1 volta al giorno)</li>
            <li><strong>+5 punti</strong> per aver caricato una foto profilo</li>
          </ul>
        </div>
      </div>

      <div id="settings" class="tab-content">
        <h2>‚öôÔ∏è Impostazioni Profilo</h2>
        <div class="form-group">
          <label>Nuova Password</label>
          <input type="password" id="newPassword" placeholder="Lascia vuoto per non cambiare" />
        </div>
        <div class="form-group">
          <label>Conferma Nuova Password</label>
          <input type="password" id="newPassword2" placeholder="Ripeti la nuova password" />
        </div>
        <div class="form-group">
          <label>Foto Profilo</label>
          <input type="file" id="profilePic" accept="image/*" onchange="previewImage(event)" />
          <div class="preview" id="previewContainer">
            <span>?</span>
          </div>
        </div>
        <button onclick="saveSettings()">Salva Impostazioni</button>
        <div id="settingsError" class="error"></div>
      </div>

      <button class="logout-btn" onclick="logout()">Esci</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // üîë Configurazione Firebase (gi√† con i tuoi dati)
    const firebaseConfig = {
      apiKey: "AIzaSyBCp4I-yA-1BhPgr5VU1dVioL4Uel1X8vE",
      authDomain: "fantautenti.firebaseapp.com",
      projectId: "fantautenti",
      storageBucket: "fantautenti.firebasestorage.app",
      messagingSenderId: "994276464470",
      appId: "1:994276464470:web:801f878675e486706528f7",
      measurementId: "G-9W1ZEE5C4R"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ======================
    // Autenticazione Email
    // ======================
    function showAuth(type) {
      document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
      document.getElementById('registerForm').style.display = type === 'register' ? 'block' : 'none';
    }

    async function register() {
      const username = document.getElementById('regUser').value.trim();
      const pass = document.getElementById('regPass').value;
      const pass2 = document.getElementById('regPass2').value;
      const err = document.getElementById('regError');
      err.textContent = '';

      if (!username || !pass || !pass2) {
        err.textContent = 'Tutti i campi sono obbligatori.';
        return;
      }
      if (pass.length < 6) {
        err.textContent = 'La password deve avere almeno 6 caratteri.';
        return;
      }
      if (pass !== pass2) {
        err.textContent = 'Le password non coincidono.';
        return;
      }

      try {
        const email = username + '@fantautenti.fake';
        const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
        await saveUserToFirestore(userCredential.user, username);
        alert('‚úÖ Registrazione completata!');
        showAuth('login');
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          err.textContent = '‚ùå Username gi√† in uso.';
        } else {
          err.textContent = 'Errore: ' + (error.message || error.code);
        }
      }
    }

    async function loginEmail() {
      const username = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value;
      const err = document.getElementById('loginError');
      err.textContent = '';

      if (!username || !pass) {
        err.textContent = 'Inserisci username e password.';
        return;
      }

      try {
        const email = username + '@fantautenti.fake';
        const userCredential = await auth.signInWithEmailAndPassword(email, pass);
        await updateLoginAndLoad(userCredential.user);
      } catch (error) {
        err.textContent = 'Username o password errati.';
      }
    }

    // ======================
    // Login con Google
    // ======================
    async function loginGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const userCredential = await auth.signInWithPopup(provider);
        await updateLoginAndLoad(userCredential.user);
      } catch (error) {
        if (error.code !== 'auth/popup-closed-by-user') {
          alert('Errore Google: ' + error.message);
        }
      }
    }

    // ======================
    // Gestione utente Firestore
    // ======================
    async function saveUserToFirestore(user, username) {
      await db.collection('users').doc(user.uid).set({
        username: username,
        points: 20,
        profilePic: user.photoURL || null,
        lastLogin: null
      });
    }

    async function updateLoginAndLoad(user) {
      let userData = null;
      const userDoc = await db.collection('users').doc(user.uid).get();

      if (!userDoc.exists) {
        // Nuovo utente Google: crea username da nome
        const baseUsername = user.displayName?.replace(/\s+/g, '') || 'utente' + Math.floor(Math.random() * 1000);
        let username = baseUsername;
        let counter = 1;
        let exists = true;
        while (exists) {
          const snapshot = await db.collection('users').where('username', '==', username).get();
          exists = !snapshot.empty;
          if (exists) {
            username = baseUsername + counter;
            counter++;
          }
        }
        await saveUserToFirestore(user, username);
        userData = { username, points: 20, profilePic: user.photoURL || null, lastLogin: null };
      } else {
        userData = userDoc.data();
        const today = new Date().toDateString();
        if (userData.lastLogin !== today) {
          await db.collection('users').doc(user.uid).update({
            points: firebase.firestore.FieldValue.increment(10),
            lastLogin: today
          });
          userData.points += 10;
          userData.lastLogin = today;
        }
      }

      loadApp(user.uid, userData.username, userData.profilePic);
    }

    // ======================
    // App principale
    // ======================
    let currentUid = null;
    let currentUsername = null;

    function loadApp(uid, username, photoURL) {
      currentUid = uid;
      currentUsername = username;
      document.getElementById('currentUser').textContent = username;
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('appScreen').style.display = 'block';
      renderLeaderboard();
      showTab('leaderboard');

      // Mostra foto in anteprima
      const preview = document.getElementById('previewContainer');
      if (photoURL) {
        preview.innerHTML = `<img src="${photoURL}" alt="Avatar">`;
      } else {
        preview.innerHTML = `<span>${username.charAt(0).toUpperCase()}</span>`;
      }
    }

    async function renderLeaderboard() {
      const snapshot = await db.collection('users').orderBy('points', 'desc').get();
      const list = document.getElementById('leaderboardList');
      list.innerHTML = '';

      snapshot.forEach((doc) => {
        const data = doc.data();
        const isCurrent = doc.id === currentUid;
        const avatar = data.profilePic 
          ? `<img src="${data.profilePic}" alt="Avatar">`
          : `<span>${data.username.charAt(0).toUpperCase()}</span>`;

        const item = document.createElement('div');
        item.className = 'leaderboard-item';
        item.innerHTML = `
          <div class="user-info">
            <div class="avatar">${avatar}</div>
            <strong>${data.username} ${isCurrent ? '(Tu)' : ''}</strong>
          </div>
          <div><strong>${data.points}</strong> punti</div>
        `;
        list.appendChild(item);
      });
    }

    // ======================
    // Impostazioni
    // ======================
    function previewImage(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('previewContainer');
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" alt="Anteprima">`;
        };
        reader.readAsDataURL(file);
      }
    }

    async function saveSettings() {
      const newPassword = document.getElementById('newPassword').value;
      const newPassword2 = document.getElementById('newPassword2').value;
      const fileInput = document.getElementById('profilePic');
      const err = document.getElementById('settingsError');
      err.textContent = '';

      try {
        if (newPassword) {
          if (newPassword.length < 6) {
            err.textContent = 'La password deve avere almeno 6 caratteri.';
            return;
          }
          if (newPassword !== newPassword2) {
            err.textContent = 'Le nuove password non coincidono.';
            return;
          }
          const user = auth.currentUser;
          if (user.email.endsWith('@fantautenti.fake')) {
            await user.updatePassword(newPassword);
          } else {
            err.textContent = 'Non puoi cambiare la password con un account Google.';
            return;
          }
        }

        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async function(e) {
            const base64 = e.target.result;
            const userRef = db.collection('users').doc(currentUid);
            const userData = (await userRef.get()).data();

            let pointsToAdd = 0;
            if (!userData.profilePic?.startsWith('http')) {
              pointsToAdd = 5;
            }

            await userRef.update({
              profilePic: base64,
              points: firebase.firestore.FieldValue.increment(pointsToAdd)
            });

            renderLeader;
          };
          reader.readAsDataURL(file);
          return;
        }

        alert('‚úÖ Impostazioni salvate!');
      } catch (error) {
        err.textContent = 'Errore: ' + (error.message || error.code);
      }
    }

    function logout() {
      auth.signOut().then(() => {
        document.getElementById('appScreen').style.display = 'none';
        document.getElementById('authScreen').style.display = 'block';
        showAuth('login');
        document.getElementById('loginUser').value = '';
        document.getElementById('loginPass').value = '';
      });
    }

    // ======================
    // Tabs
    // ======================
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.getElementById('tab-' + tabId).classList.add('active');
    }

    // Listener persistente
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          loadApp(user.uid, data.username, data.profilePic);
        } else {
          // Utente nuovo (es. Google mai visto)
          await updateLoginAndLoad(user);
        }
      }
    });
  </script>
</body>
</html>
